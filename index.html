<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ECNA Gestion Visa - Extension Trimble Connect</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        background-color: #f0f0f0;
        color: #333;
        text-align: center;
        display: flex;
        flex-direction: column;
        height: 100vh;
      }
      .header-banner {
        background-color: #ff0101; /* Rouge Eiffage */
        padding: 10px 20px;
        display: flex;
        justify-content: flex-start;
        align-items: center;
        gap: 15px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        flex-shrink: 0; /* Empêche le bandeau de rétrécir */
      }
      .header-banner button {
        background-color: #ffffff;
        color: #000000;
        border: none;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1rem;
        transition:
          background-color 0.3s ease,
          color 0.3s ease;
      }
      .header-banner button:hover {
        background-color: #e0e0e0;
        color: #003a72;
      }

      .main-content {
        flex-grow: 1; /* Prend l'espace restant */
        padding: 20px;
        overflow-y: auto; /* Ajoute un défilement si le contenu dépasse */
        text-align: left; /* Aligne le texte à gauche pour le tableau */
      }
      .main-content h1 {
        color: #0056b3;
        margin-bottom: 20px;
        text-align: center;
      }

      /* Styles pour le tableau des visas */
      .visa-table-container {
        width: 100%;
        max-width: 1200px; /* Limite la largeur maximale du tableau */
        margin: 0 auto; /* Centre le tableau */
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        overflow-x: auto; /* Permet le défilement horizontal si le tableau est trop large */
      }
      .visa-table {
        width: 100%;
        border-collapse: collapse; /* Supprime l'espace entre les bordures de cellules */
      }
      .visa-table th,
      .visa-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #ddd;
        text-align: left;
      }
      .visa-table th {
        background-color: #f8f8f8;
        font-weight: bold;
        color: #333;
        position: sticky; /* Pour garder les en-têtes visibles lors du défilement */
        top: 0;
        z-index: 10;
      }
      .visa-table tbody tr:hover {
        background-color: #f1f1f1;
      }
      .visa-table th .filter-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .visa-table th .filter-icon {
        cursor: pointer;
        margin-left: 8px;
        color: #333333;
        font-size: 0.9em;
      }
      .visa-table th .filter-icon:hover {
        color: #0056b3;
      }
    </style>
  </head>
  <body>
    <div class="header-banner">
      <button id="dashboardBtn">Tableau de Bord</button>
      <button id="visasBtn">Visas</button>
      <button id="configBtn">Configuration</button>
    </div>

    <div id="mainContent" class="main-content">
      <!-- Le contenu est injecté ici par JavaScript -->
      <p>Bienvenue sur l'interface de gestion de visa ECNA !</p>
    </div>

    <script src="https://components.connect.trimble.com/trimble-connect-workspace-api/index.js"></script>
    <script>
      (async function () {
        let triconnectAPI;
        let globalAccessToken = null;
        const mainContentDiv = document.getElementById("mainContent");

        const TRIMBLE_CLIENT_ID = "db958c40-8b49-4d72-b9cc-71333d3c9581"; // Ton ID Client est ici

        // --- DEBUT DE LA SECTION POUR LES DONNEES ET LE TABLEAU DES VISAS ---

        // Fonction pour afficher le tableau des visas avec les données réelles
        async function displayVisaTable() {
          mainContentDiv.innerHTML = `
                    <h1>Chargement des Documents à Visas...</h1>
                    <div style="text-align:center; padding: 20px;">
                        <img src="https://dorianlorenzato-max.github.io/trimble-connect-ecna-extension/Loading_icon.gif" alt="Chargement..." style="width: 50px;">
                    </div>
                `;

          let visaDocuments = [];
          //let projectGroups = [];

          try {
            if (
              typeof globalAccessToken !== "string" ||
              globalAccessToken.length === 0
            ) {
              throw new Error(
                "Access Token non disponible ou invalide. L'initialisation a échoué.",
              );
            }
            const projectInfo = await triconnectAPI.project.getCurrentProject();
            const projectId = projectInfo.id;
            const rootId = projectInfo.rootId;

            // --- DEBUT AJOUT POUR RECUPERER LES GROUPES ---
            const groupsApiUrl = `https://app21.connect.trimble.com/tc/api/2.0/groups?projectId=${projectId}`; // Endpoint pour récupérer tous les groupes
            console.log(
              "Tentative de récupération des groupes via:",
              groupsApiUrl,
            );

            const groupsResponse = await fetch(groupsApiUrl, {
              headers: {
                Authorization: `Bearer ${globalAccessToken}`,
                "Content-Type": "application/json",
                //"Trimble-Client-Id": TRIMBLE_CLIENT_ID,
                //Accept: "application/vnd.trimble.connect.app+json",
              },
            });

            if (!groupsResponse.ok) {
              const errorData = await groupsResponse
                .json()
                .catch(() => ({ message: groupsResponse.statusText }));
              throw new Error(
                `Erreur API Trimble Connect (groupes) (${groupsResponse.status}): ${errorData.message}`,
              );
            }
            const allGroups = await groupsResponse.json();
            console.log("Groupes reçus de l'API REST:", allGroups);
            // --- FIN POUR RECUPERER LES GROUPES ---

            //  Récupérer les utilisateurs de chaque groupe et créer la map user ID -> group Name
            const userToGroupMap = new Map(); // Map pour stocker userId -> groupName

            // Pour chaque groupe récupéré, obtenir ses utilisateurs
            for (const group of allGroups) {
              const usersInGroupApiUrl = `https://app21.connect.trimble.com/tc/api/2.0/groups/${group.id}/users`;
              console.log(
                `Tentative de récupération des utilisateurs pour le groupe '${group.name}' (${group.id}) via:`,
                usersInGroupApiUrl,
              );

              const usersInGroupResponse = await fetch(usersInGroupApiUrl, {
                headers: {
                  Authorization: `Bearer ${globalAccessToken}`,
                  "Content-Type": "application/json",
                  //"Trimble-Client-Id": TRIMBLE_CLIENT_ID,
                  //Accept: "application/vnd.trimble.connect.app+json",
                },
              });

              if (!usersInGroupResponse.ok) {
                const errorData = await usersInGroupResponse
                  .json()
                  .catch(() => ({ message: usersInGroupResponse.statusText }));
                console.warn(
                  `Erreur API Trimble Connect (utilisateurs du groupe ${group.id}) (${usersInGroupResponse.status}): ${errorData.message}`,
                );
                continue; // Passe au groupe suivant si une erreur survient pour ce groupe
              }

              const groupUsers = await usersInGroupResponse.json();
              console.log(
                `Utilisateurs pour le groupe '${group.name}' (${group.id}):`,
                groupUsers,
              );

              // Mappage : Pour chaque utilisateur, associer son ID au nom du groupe
              // Si un utilisateur est dans plusieurs groupes, le premier groupe trouvé sera utilisé (selon cette logique).
              for (const user of groupUsers) {
                if (!userToGroupMap.has(user.id)) {
                  // Pour s'assurer qu'on prend le premier groupe trouvé si l'utilisateur est dans plusieurs.
                  userToGroupMap.set(user.id, group.name);
                }
              }
            }
            console.log(
              "Mappage final des utilisateurs aux groupes:",
              userToGroupMap,
            );
            // --- FIN MODIFICATIONS POUR LES GROUPES ET UTILISATEURS ---

            //début pour Récupération les fichiers PDF
            // TODO (Étape ultérieure) : Filtrer les fichiers en fonction des dossiers paramétrés par l'administrateur.
            const filesApiUrl = `https://app21.connect.trimble.com/tc/api/2.0/folders/9QpmVaoiJOc/items`;

            const response = await fetch(filesApiUrl, {
              headers: {
                Authorization: `Bearer ${globalAccessToken}`,
                "Content-Type": "application/json",
                //"Trimble-Client-Id": TRIMBLE_CLIENT_ID,
                //Accept: "application/vnd.trimble.connect.app+json",
              },
            });

            if (!response.ok) {
              const errorData = await response
                .json()
                .catch(() => ({ message: response.statusText }));
              throw new Error(
                `Erreur API Trimble Connect (${response.status}): ${errorData.message}`,
              );
            }

            const apiResponse = await response.json();
            const projectFiles = apiResponse || [];
            console.log("Fichiers reçus de l'API REST:", projectFiles);

            const pdfFiles = projectFiles.filter(
              (file) => file.name && file.name.toLowerCase().endsWith(".pdf"),
            );
            console.log("Fichiers PDF filtrés:", pdfFiles);

            for (const file of pdfFiles) {
              const depositorId = file.modifiedBy ? file.modifiedBy.id : null;
              const depositorName = file.modifiedBy
                ? `${file.modifiedBy.firstName || ""} ${file.modifiedBy.lastName || ""}`.trim()
                : "Inconnu";
              const depositDate = file.modifiedOn
                ? new Date(file.modifiedOn).toLocaleDateString()
                : "Date inconnue";

              //fin de récupération des fichiers, des dates et noms des dépositaires
              const fileVersion = file.revision || "N/A";
              const lot = depositorId
                ? userToGroupMap.get(depositorId) || "Non assigné"
                : "Non assigné";
              const status = file_VISA || "en travaux";

              visaDocuments.push({
                name: file.name,
                version: fileVersion,
                lot: lot,
                depositorName: depositorName,
                depositDate: depositDate,
                status: status,
              });
            }
          } catch (error) {
            console.error(
              "Erreur lors de la récupération des documents Trimble Connect:",
              error,
            );
            mainContentDiv.innerHTML = `
                        <h1>Erreur de chargement des documents</h1>
                        <p>Impossible de récupérer les documents. Veuillez vérifier la console du navigateur pour les détails techniques.</p>
                        <p>Détails de l'erreur : ${error.message || error}</p>
                    `;
            return;
          }

          let tableRows = visaDocuments
            .map(
              (doc) => `
                    <tr>
                        <td>${doc.name || ""}</td>
                        <td>${doc.version || ""}</td>
                        <td>${doc.lot || ""}</td>
                        <td>${doc.depositorName || ""}</td>
                        <td>${doc.depositDate || ""}</td>
                        <td>${doc.status || ""}</td>
                    </tr>
                `,
            )
            .join("");

          if (visaDocuments.length === 0) {
            tableRows = `<tr><td colspan="6" style="text-align:center;">Aucun document PDF trouvé dans le projet.</td></tr>`;
          }

          mainContentDiv.innerHTML = `
                    <h1>Suivi des Documents à Visas</h1>
                    <div class="visa-table-container">
                        <table class="visa-table">
                            <thead>
                                <tr>
                                    <th>
                                        <div class="filter-header">
                                            Nom du document
                                            <span class="filter-icon" title="Filtrer par nom">▼</span>
                                        </div>
                                    </th>
                                    <th>
                                        <div class="filter-header">
                                            Version
                                            <span class="filter-icon" title="Filtrer par version">▼</span>
                                        </div>
                                    </th>
                                    <th>
                                        <div class="filter-header">
                                            Lot
                                            <span class="filter-icon" title="Filtrer par lot">▼</span>
                                        </div>
                                    </th>
                                    <th>
                                        <div class="filter-header">
                                            Nom du dépositaire
                                            <span class="filter-icon" title="Filtrer par dépositaire">▼</span>
                                        </div>
                                    </th>
                                    <th>
                                        <div class="filter-header">
                                            Date de dépôt
                                            <span class="filter-icon" title="Filtrer par date">▼</span>
                                        </div>
                                    </th>
                                    <th>
                                        <div class="filter-header">
                                            Statut
                                            <span class="filter-icon" title="Filtrer par statut">▼</span>
                                        </div>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRows}
                            </tbody>
                        </table>
                    </div>
                `;
        }

        // --- SECTION D'INITIALISATION PRINCIPALE ---
        try {
          mainContentDiv.innerHTML = `<p>Connexion à Trimble Connect...</p>`;
          triconnectAPI = await TrimbleConnectWorkspace.connect(
            window.parent,
            (event, data) => {
              console.log("Événement Trimble Connect reçu : ", event, data);
              if (
                event === "extension.command" &&
                data === "ecna_gestion_visa_clicked"
              ) {
                console.log("Le menu ECNA Gestion Visa a été cliqué !");
                //displayVisaTable();
              }
            },
            30000,
          );
          console.log("Connexion à Trimble Connect établie.");

          mainContentDiv.innerHTML = `<p>Récupération du jeton d'accès...</p>`;
          const fetchedToken =
            await triconnectAPI.extension.requestPermission("accesstoken");
          console.log("Valeur brute du jeton d'accès reçu:", fetchedToken);

          if (typeof fetchedToken === "string" && fetchedToken.length > 0) {
            globalAccessToken = fetchedToken;
            console.log(
              "Access Token Trimble Connect obtenu et validé avec succès.",
            );
          } else {
            console.warn(
              "Impossible d'obtenir un Access Token Trimble Connect valide. Valeur reçue:",
              fetchedToken,
            );
            throw new Error(
              "L'Access Token n'a pas pu être récupéré durant l'initialisation ou est invalide.",
            );
          }

          // CORRECTION ICI : la vérification doit être si l'ID est vide, pas s'il est égal à une valeur spécifique
          if (TRIMBLE_CLIENT_ID.length === 0) {
            throw new Error(
              "TRIMBLE_CLIENT_ID non configuré. Veuillez le renseigner dans le code.",
            );
          }

          const projectInfo = await triconnectAPI.project.getCurrentProject();
          console.log("Projet actuel :", projectInfo.name);

          const mainMenuObject = {
            title: "ECNA Gestion Visa",
            icon: "https://dorianlorenzato-max.github.io/trimble-connect-ecna-extension/logoEiffage.png",
            command: "ecna_gestion_visa_clicked",
          };
          triconnectAPI.ui.setMenu(mainMenuObject);
          console.log("Menu 'ECNA Gestion Visa' envoyé à Trimble Connect.");

          document
            .getElementById("visasBtn")
            .addEventListener("click", displayVisaTable);

          mainContentDiv.innerHTML = `<p>Bienvenue sur l'interface de gestion de visa ECNA ! Cliquez sur un bouton ci-dessus pour commencer.</p>`;
        } catch (error) {
          console.error(
            "Erreur lors de l'initialisation de l'extension :",
            error,
          );
          mainContentDiv.innerHTML = `
                    <h1>Erreur d'initialisation de l'extension</h1>
                    <p>Impossible de charger l'extension. Veuillez vérifier la console du navigateur pour plus de détails.</p>
                    <p>Détails de l'erreur : ${error.message || error}</p>
                `;
        }
      })();
    </script>
  </body>
</html>
